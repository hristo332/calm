<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CALM Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    body { margin: 0; background: #fff; }
    
    /* Date picker styling */
    input[type="date"] {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }
    
    /* Period toggle */
    .period-btn {
      transition: all 0.15s ease;
    }
    .period-btn.active {
      background: #1F2937;
      color: white;
    }
    .period-btn:not(.active):hover {
      background: #F3F4F6;
    }
    
    /* Nav arrows */
    .nav-arrow {
      transition: all 0.15s ease;
    }
    .nav-arrow:hover {
      background: #F3F4F6;
    }
    .nav-arrow:active {
      transform: scale(0.95);
    }
    
    /* Embed mode - compact */
    .embed-mode {
      padding: 12px !important;
    }
    .embed-mode #navbar {
      display: none !important;
    }
    .embed-mode #periodLabel {
      display: none !important;
    }
    .embed-mode .main-container {
      max-width: 100% !important;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      #app {
        padding: 12px !important;
      }
      
      .main-container {
        flex-direction: column !important;
        gap: 20px !important;
      }
      
      .main-container > div {
        width: 100% !important;
        min-width: unset !important;
        max-width: 100% !important;
      }
      
      .chart-container {
        height: 200px !important;
      }
      
      .donut-section {
        flex-direction: column !important;
        align-items: center !important;
        gap: 16px !important;
      }
      
      .donut-wrapper {
        width: 120px !important;
        height: 120px !important;
      }
      
      .legend-wrapper {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 12px !important;
      }
      
      #categoryCards {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
      
      #categoryCards > div {
        padding: 12px !important;
      }
      
      #categoryCards p.text-2xl {
        font-size: 1.25rem !important;
      }
      
      /* Mobile navbar */
      #navbar {
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      .date-nav {
        justify-content: center !important;
      }
      
      .period-toggle {
        justify-content: center !important;
      }
      
      .period-btn {
        padding: 8px 12px !important;
        font-size: 12px !important;
      }
      
      /* Embed mobile */
      .embed-mode #embedHeader h3 {
        font-size: 14px !important;
      }
      
      .embed-mode .stats-summary {
        flex-direction: row !important;
        align-items: center !important;
        gap: 8px !important;
      }
      
      .embed-mode .stats-summary .total-hours {
        font-size: 2rem !important;
      }
      
      .embed-mode #categoryCards {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 380px) {
      #categoryCards {
        grid-template-columns: 1fr !important;
      }
      
      .period-btn {
        padding: 6px 8px !important;
        font-size: 11px !important;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="p-6">
    <!-- Navigation Bar (hidden in embed mode) -->
    <div id="navbar" class="flex items-center justify-between mb-6 main-container">
      <!-- Date Navigation -->
      <div class="date-nav flex items-center gap-2">
        <button onclick="navigateDate(-1)" class="nav-arrow w-10 h-10 flex items-center justify-center rounded-lg text-gray-500 hover:text-gray-900">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        
        <input 
          type="date" 
          id="datePicker" 
          class="px-4 py-2 text-base font-semibold text-gray-900 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent cursor-pointer"
        />
        
        <button onclick="navigateDate(1)" class="nav-arrow w-10 h-10 flex items-center justify-center rounded-lg text-gray-500 hover:text-gray-900">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
        
        <button onclick="goToToday()" class="ml-2 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
          –î–Ω–µ—Å
        </button>
      </div>
      
      <!-- Period Toggle -->
      <div class="period-toggle flex items-center gap-1 bg-gray-100 p-1 rounded-lg">
        <button onclick="setPeriod('day')" class="period-btn px-4 py-1.5 text-sm font-medium rounded-md" data-period="day">
          –î–µ–Ω
        </button>
        <button onclick="setPeriod('week')" class="period-btn px-4 py-1.5 text-sm font-medium rounded-md" data-period="week">
          –°–µ–¥–º–∏—Ü–∞
        </button>
        <button onclick="setPeriod('month')" class="period-btn px-4 py-1.5 text-sm font-medium rounded-md" data-period="month">
          –ú–µ—Å–µ—Ü
        </button>
        <button onclick="setPeriod('year')" class="period-btn px-4 py-1.5 text-sm font-medium rounded-md" data-period="year">
          –ì–æ–¥–∏–Ω–∞
        </button>
      </div>
    </div>

    <!-- Period Label (hidden in embed mode) -->
    <div id="periodLabel" class="mb-4 main-container">
      <span class="text-sm text-gray-500" id="periodRangeText"></span>
    </div>

    <!-- Embed Header (only shown in embed mode) -->
    <div id="embedHeader" class="hidden mb-3">
      <h3 class="text-base font-bold text-gray-900" id="embedTitle">üìä –†–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ –¥–µ–Ω—è</h3>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex items-center justify-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
      <span class="ml-3 text-gray-600">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden">
      <!-- Main Dashboard - Responsive Layout -->
      <div class="main-container flex gap-8 items-start">
        
        <!-- Section 1: What got done -->
        <div class="stats-summary flex-shrink-0 w-48">
          <h2 class="text-lg font-bold text-gray-900 mb-2">–ö–∞–∫–≤–æ —Å–≤—ä—Ä—à–∏—Ö</h2>
          <p class="text-gray-500 text-sm leading-relaxed">
            –õ–æ–≥–Ω–∞—Ö <span id="totalHours" class="total-hours font-bold text-3xl text-gray-900 block mt-1">0</span>
            <span id="periodSuffix">—á–∞—Å–∞ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</span>
          </p>
        </div>
        
        <!-- Section 2: Productivity Chart -->
        <div class="flex-grow" style="min-width: 280px; max-width: 420px;">
          <h3 class="text-base font-semibold text-gray-900 mb-3" id="chartTitle">–î–Ω–µ–≤–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç</h3>
          <div class="chart-container" style="height: 180px;">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        
        <!-- Section 3: Time Distribution Donut -->
        <div class="flex-shrink-0">
          <h3 class="text-base font-semibold text-gray-900 mb-3">–†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
          <div class="donut-section flex items-center gap-5">
            <div class="donut-wrapper" style="width: 140px; height: 140px;">
              <canvas id="donutChart"></canvas>
            </div>
            <div id="legend" class="legend-wrapper space-y-2"></div>
          </div>
        </div>
        
      </div>
      
      <!-- Category Summary Cards -->
      <div class="grid grid-cols-4 gap-4 mt-6 main-container" id="categoryCards"></div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center py-8">
      <div class="text-red-500 text-lg mb-2">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</div>
      <p id="errorMessage" class="text-gray-500 text-sm"></p>
      <button onclick="loadData()" class="mt-4 px-4 py-2 bg-gray-900 text-white rounded-lg text-sm hover:bg-gray-700">
        –û–ø–∏—Ç–∞–π –ø–∞–∫
      </button>
    </div>
  </div>

  <script>
    // ============================================
    // URL PARAMETERS - HASH BASED FOR NOTION
    // ============================================
    const urlParams = new URLSearchParams(window.location.search);
    const hashValue = window.location.hash.replace('#', '');
    
    // Parse hash: can be just date (2024-12-11) or date:period (2024-12-11:day)
    let paramDate = null;
    let paramPeriod = null;
    
    if (hashValue) {
      const parts = hashValue.split(':');
      paramDate = parts[0] || null;
      paramPeriod = parts[1] || null;
    }
    
    // Fallback to query params for backwards compatibility
    if (!paramDate) paramDate = urlParams.get('date');
    if (!paramPeriod) paramPeriod = urlParams.get('period');
    
    const isEmbedMode = urlParams.get('embed') === 'true' || hashValue.includes('embed');

    // ============================================
    // STATE
    // ============================================
    let currentDate = paramDate ? new Date(paramDate + 'T12:00:00') : new Date();
    let currentPeriod = paramPeriod || 'day'; // Default to day for embed
    let barChart = null;
    let donutChart = null;

    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      apiEndpoint: '/api/notion-data',
      refreshInterval: 5 * 60 * 1000
    };

    const COLORS = {
      MVT: '#E8505B',
      Priority: '#F9A03F',
      Personal: '#7B68EE',
      Recharge: '#3CB371'
    };

    const PERIOD_LABELS = {
      day: { suffix: '—á–∞—Å–∞ –¥–Ω–µ—Å', chart: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç' },
      week: { suffix: '—á–∞—Å–∞ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞', chart: '–î–Ω–µ–≤–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç' },
      month: { suffix: '—á–∞—Å–∞ —Ç–æ–∑–∏ –º–µ—Å–µ—Ü', chart: '–°–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç' },
      year: { suffix: '—á–∞—Å–∞ —Ç–∞–∑–∏ –≥–æ–¥–∏–Ω–∞', chart: '–ú–µ—Å–µ—á–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç' }
    };

    const MONTH_NAMES = ['–Ø–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞–π', '–Æ–Ω–∏', 
                         '–Æ–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];

    const DAY_NAMES = ['–ù–µ–¥', '–ü–æ–Ω', '–í—Ç–æ', '–°—Ä—è', '–ß–µ—Ç', '–ü–µ—Ç', '–°—ä–±'];

    // ============================================
    // EMBED MODE SETUP
    // ============================================
    function setupEmbedMode() {
      if (isEmbedMode) {
        document.getElementById('app').classList.add('embed-mode');
        document.getElementById('embedHeader').classList.remove('hidden');
        
        // Update embed title based on date
        const dateStr = formatDateLong(currentDate);
        document.getElementById('embedTitle').textContent = `üìä ${dateStr}`;
      }
    }

    function formatDateLong(date) {
      const day = date.getDate();
      const month = MONTH_NAMES[date.getMonth()];
      const dayName = DAY_NAMES[date.getDay()];
      return `${dayName}, ${day} ${month}`;
    }

    // ============================================
    // DATE NAVIGATION
    // ============================================
    function navigateDate(direction) {
      const date = new Date(currentDate);
      
      switch (currentPeriod) {
        case 'day':
          date.setDate(date.getDate() + direction);
          break;
        case 'week':
          date.setDate(date.getDate() + (direction * 7));
          break;
        case 'month':
          date.setMonth(date.getMonth() + direction);
          break;
        case 'year':
          date.setFullYear(date.getFullYear() + direction);
          break;
      }
      
      currentDate = date;
      updateDatePicker();
      loadData();
    }

    function goToToday() {
      currentDate = new Date();
      updateDatePicker();
      loadData();
    }

    function updateDatePicker() {
      const picker = document.getElementById('datePicker');
      if (picker) {
        picker.value = currentDate.toISOString().split('T')[0];
      }
    }

    function onDateChange(event) {
      currentDate = new Date(event.target.value + 'T12:00:00');
      loadData();
    }

    // ============================================
    // PERIOD TOGGLE
    // ============================================
    function setPeriod(period) {
      currentPeriod = period;
      
      // Update button states
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      
      // Update labels
      document.getElementById('periodSuffix').textContent = PERIOD_LABELS[period].suffix;
      document.getElementById('chartTitle').textContent = PERIOD_LABELS[period].chart;
      
      loadData();
    }

    function updatePeriodRangeText(dateRange) {
      const start = new Date(dateRange.start);
      const end = new Date(dateRange.end);
      let text = '';
      
      switch (currentPeriod) {
        case 'day':
          text = formatDateFull(start);
          break;
        case 'week':
          text = `${formatDate(start)} ‚Äî ${formatDate(end)}`;
          break;
        case 'month':
          text = `${MONTH_NAMES[start.getMonth()]} ${start.getFullYear()}`;
          break;
        case 'year':
          text = `${start.getFullYear()} –≥–æ–¥–∏–Ω–∞`;
          break;
      }
      
      document.getElementById('periodRangeText').textContent = text;
      
      // Update embed header if in embed mode
      if (isEmbedMode) {
        const dayName = DAY_NAMES[start.getDay()];
        if (currentPeriod === 'day') {
          document.getElementById('embedTitle').textContent = `üìä ${dayName}, ${start.getDate()} ${MONTH_NAMES[start.getMonth()]}`;
        } else {
          document.getElementById('embedTitle').textContent = `üìä ${text}`;
        }
      }
    }

    function formatDate(date) {
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      return `${day}.${month}`;
    }

    function formatDateFull(date) {
      const day = date.getDate();
      const month = MONTH_NAMES[date.getMonth()];
      const year = date.getFullYear();
      return `${day} ${month} ${year}`;
    }

    // ============================================
    // UI STATE
    // ============================================
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // ============================================
    // API
    // ============================================
    async function fetchData() {
      const dateStr = currentDate.toISOString().split('T')[0];
      const url = `${CONFIG.apiEndpoint}?date=${dateStr}&period=${currentPeriod}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error || `HTTP ${response.status}`);
      }
      
      return response.json();
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderDashboard(data) {
      const { totals, chartData, dateRange } = data;
      const totalHours = Object.values(totals).reduce((a, b) => a + b, 0);

      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      updatePeriodRangeText(dateRange);

      renderBarChart(chartData, totals);
      renderDonutChart(totals, totalHours);
      renderLegend(totals, totalHours);
      renderCategoryCards(totals, totalHours);
      
      showDashboard();
    }

    function renderBarChart(data, totals) {
      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();

      // For day view, show a horizontal bar chart instead
      if (currentPeriod === 'day') {
        const categories = ['MVT', 'Priority', 'Personal', 'Recharge'];
        const values = categories.map(c => totals[c] || 0);
        const hasData = values.some(v => v > 0);

        barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: categories,
            datasets: [{
              data: hasData ? values : [0.1, 0.1, 0.1, 0.1],
              backgroundColor: hasData ? categories.map(c => COLORS[c]) : ['#E5E7EB', '#E5E7EB', '#E5E7EB', '#E5E7EB'],
              borderRadius: 6,
              barThickness: 24
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: hasData,
                backgroundColor: '#1F2937',
                titleFont: { size: 13, weight: '600' },
                bodyFont: { size: 12 },
                padding: 12,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    return ' ' + context.parsed.x.toFixed(1) + ' —á–∞—Å–∞';
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: '#F3F4F6', drawBorder: false },
                border: { display: false },
                ticks: { 
                  color: '#9CA3AF', 
                  font: { size: 11 },
                  callback: value => value + '—á'
                }
              },
              y: {
                grid: { display: false },
                border: { display: false },
                ticks: { 
                  color: '#6B7280', 
                  font: { size: 12, weight: '500' }
                }
              }
            }
          }
        });
        return;
      }

      // For other periods, use stacked bar chart
      const labels = data.map(d => d.label);

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'MVT', data: data.map(d => d.MVT), backgroundColor: COLORS.MVT },
            { label: 'Priority', data: data.map(d => d.Priority), backgroundColor: COLORS.Priority },
            { label: 'Personal', data: data.map(d => d.Personal), backgroundColor: COLORS.Personal },
            { label: 'Recharge', data: data.map(d => d.Recharge), backgroundColor: COLORS.Recharge }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1F2937',
              titleFont: { size: 13, weight: '600' },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const bucket = data[idx];
                  const total = (bucket.MVT || 0) + (bucket.Priority || 0) + (bucket.Personal || 0) + (bucket.Recharge || 0);
                  return '\n–û–±—â–æ: ' + total.toFixed(1) + '—á';
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { 
                color: '#6B7280', 
                font: { size: currentPeriod === 'year' ? 10 : 12, weight: '500' },
                maxRotation: 0
              }
            },
            y: {
              stacked: true,
              grid: { color: '#F3F4F6', drawBorder: false },
              border: { display: false },
              ticks: { 
                color: '#9CA3AF', 
                font: { size: 11 },
                callback: value => value + '—á',
                stepSize: currentPeriod === 'day' ? 1 : 2
              }
            }
          },
          borderRadius: 4,
          barPercentage: currentPeriod === 'year' ? 0.6 : 0.7,
          categoryPercentage: 0.8
        }
      });
    }

    function renderDonutChart(totals, totalHours) {
      const ctx = document.getElementById('donutChart').getContext('2d');
      if (donutChart) donutChart.destroy();

      const chartData = Object.entries(totals)
        .filter(([_, value]) => value > 0)
        .map(([category, value]) => ({ category, value, color: COLORS[category] }));

      if (chartData.length === 0) {
        chartData.push({ category: '–ù—è–º–∞ –¥–∞–Ω–Ω–∏', value: 1, color: '#E5E7EB' });
      }

      donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: chartData.map(d => d.category),
          datasets: [{
            data: chartData.map(d => d.value),
            backgroundColor: chartData.map(d => d.color),
            borderWidth: 0,
            cutout: '55%',
            spacing: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1F2937',
              titleFont: { size: 13, weight: '600' },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
                  return ' ' + value.toFixed(1) + '—á (' + pct + '%)';
                }
              }
            }
          }
        }
      });
    }

    function renderLegend(totals, totalHours) {
      const order = ['MVT', 'Priority', 'Personal', 'Recharge'];
      const legendHtml = order
        .filter(cat => totals[cat] > 0)
        .map(category => {
          const value = totals[category];
          const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
          return `
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded" style="background-color: ${COLORS[category]}"></div>
              <span class="text-sm text-gray-600">${category}</span>
              <span class="text-sm font-semibold text-gray-900">${pct}%</span>
            </div>
          `;
        }).join('');
      
      document.getElementById('legend').innerHTML = legendHtml || '<span class="text-sm text-gray-400">–ù—è–º–∞ –¥–∞–Ω–Ω–∏</span>';
    }

    function renderCategoryCards(totals, totalHours) {
      const cardConfig = {
        MVT: { 
          bg: 'bg-red-50', border: 'border-red-100', dot: 'bg-red-500',
          label: 'text-red-700', value: 'text-red-800', desc: 'text-red-600',
          subtitle: '–ù–∞–π-–≤–∞–∂–Ω–∏'
        },
        Priority: { 
          bg: 'bg-orange-50', border: 'border-orange-100', dot: 'bg-orange-500',
          label: 'text-orange-700', value: 'text-orange-800', desc: 'text-orange-600',
          subtitle: '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∏'
        },
        Personal: { 
          bg: 'bg-purple-50', border: 'border-purple-100', dot: 'bg-purple-500',
          label: 'text-purple-700', value: 'text-purple-800', desc: 'text-purple-600',
          subtitle: '–õ–∏—á–Ω–∏'
        },
        Recharge: { 
          bg: 'bg-green-50', border: 'border-green-100', dot: 'bg-green-500',
          label: 'text-green-700', value: 'text-green-800', desc: 'text-green-600',
          subtitle: '–ü–æ—á–∏–≤–∫–∞'
        }
      };

      const order = ['MVT', 'Priority', 'Personal', 'Recharge'];
      const cardsHtml = order.map(category => {
        const cfg = cardConfig[category];
        const value = totals[category] || 0;
        const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
        
        return `
          <div class="${cfg.bg} rounded-xl p-4 border ${cfg.border}">
            <div class="flex items-center gap-2 mb-1">
              <div class="w-2.5 h-2.5 rounded-full ${cfg.dot}"></div>
              <span class="text-xs font-semibold ${cfg.label}">${category}</span>
            </div>
            <p class="text-2xl font-bold ${cfg.value}">${value.toFixed(1)}—á</p>
            <p class="text-xs ${cfg.desc} mt-1">${pct}%</p>
            <p class="text-xs text-gray-400 mt-0.5">${cfg.subtitle}</p>
          </div>
        `;
      }).join('');
      
      document.getElementById('categoryCards').innerHTML = cardsHtml;
    }

    // ============================================
    // MAIN
    // ============================================
    async function loadData() {
      showLoading();
      
      try {
        const data = await fetchData();
        renderDashboard(data);
      } catch (error) {
        console.error('Load error:', error);
        showError(error.message || '–ù–µ—É—Å–ø–µ—à–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å Notion');
      }
    }

    function init() {
      // Setup embed mode if needed
      setupEmbedMode();
      
      // Set initial date from URL or today
      updateDatePicker();
      
      // Add event listener to date picker
      const picker = document.getElementById('datePicker');
      if (picker) {
        picker.addEventListener('change', onDateChange);
      }
      
      // Set initial period from URL or default
      setPeriod(currentPeriod);
      
      // Auto-refresh
      setInterval(loadData, CONFIG.refreshInterval);
    }

    // Start
    init();
  </script>
</body>
</html>
