<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CALM Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    body { margin: 0; background: #fff; }
  </style>
</head>
<body>
  <div id="app" class="p-6">
    <!-- Loading State -->
    <div id="loading" class="flex items-center justify-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
      <span class="ml-3 text-gray-600">Зареждане...</span>
    </div>

    <!-- Dashboard Content (hidden until loaded) -->
    <div id="dashboard" class="hidden">
      <!-- Main Dashboard - Horizontal Layout -->
      <div class="flex gap-8 items-start max-w-5xl">
        
        <!-- Section 1: What got done -->
        <div class="flex-shrink-0 w-48">
          <h2 class="text-lg font-bold text-gray-900 mb-2">Какво свърших</h2>
          <p class="text-gray-500 text-sm leading-relaxed">
            Логнах <span id="totalHours" class="font-bold text-3xl text-gray-900 block mt-1">0</span>
            часа тази седмица
          </p>
        </div>
        
        <!-- Section 2: Daily Productivity Bar Chart -->
        <div class="flex-grow" style="min-width: 320px; max-width: 420px;">
          <h3 class="text-base font-semibold text-gray-900 mb-3">Дневна продуктивност</h3>
          <div style="height: 180px;">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        
        <!-- Section 3: Time Distribution Donut -->
        <div class="flex-shrink-0">
          <h3 class="text-base font-semibold text-gray-900 mb-3">Разпределение на времето</h3>
          <div class="flex items-center gap-5">
            <div style="width: 140px; height: 140px;">
              <canvas id="donutChart"></canvas>
            </div>
            <div id="legend" class="space-y-2">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Category Summary Cards -->
      <div class="grid grid-cols-4 gap-4 mt-6 max-w-5xl" id="categoryCards">
        <!-- Filled by JS -->
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center py-8">
      <div class="text-red-500 text-lg mb-2">⚠️ Грешка при зареждане</div>
      <p id="errorMessage" class="text-gray-500 text-sm"></p>
      <button onclick="init()" class="mt-4 px-4 py-2 bg-gray-900 text-white rounded-lg text-sm hover:bg-gray-700">
        Опитай пак
      </button>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      apiEndpoint: '/api/notion-data',
      refreshInterval: 5 * 60 * 1000 // 5 minutes
    };

    // ============================================
    // COLORS - Matching Sunsama/Notion style
    // ============================================
    const COLORS = {
      MVT: '#E8505B',
      Priority: '#F9A03F',
      Personal: '#7B68EE',
      Recharge: '#3CB371'
    };

    // ============================================
    // SAMPLE DATA (fallback)
    // ============================================
    function getSampleData() {
      return [
        { day: 'Пон', MVT: 2.5, Priority: 1.5, Personal: 0.5, Recharge: 1 },
        { day: 'Вт', MVT: 3, Priority: 1, Personal: 0.5, Recharge: 0.5 },
        { day: 'Ср', MVT: 2, Priority: 2, Personal: 1, Recharge: 1 },
        { day: 'Чет', MVT: 3.5, Priority: 0.5, Personal: 0.5, Recharge: 0.5 },
        { day: 'Пет', MVT: 2, Priority: 1.5, Personal: 0.5, Recharge: 1.5 },
        { day: 'Съб', MVT: 0.5, Priority: 0, Personal: 2, Recharge: 2 },
        { day: 'Нед', MVT: 0, Priority: 0, Personal: 1, Recharge: 3 }
      ];
    }

    // ============================================
    // UI STATE MANAGEMENT
    // ============================================
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // ============================================
    // API INTEGRATION
    // ============================================
    async function fetchNotionData() {
      try {
        const response = await fetch(CONFIG.apiEndpoint);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return data.weekData || getSampleData();
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    // ============================================
    // CHART RENDERING
    // ============================================
    let barChart = null;
    let donutChart = null;

    function calculateTotals(data) {
      return data.reduce((acc, day) => {
        acc.MVT += day.MVT || 0;
        acc.Priority += day.Priority || 0;
        acc.Personal += day.Personal || 0;
        acc.Recharge += day.Recharge || 0;
        return acc;
      }, { MVT: 0, Priority: 0, Personal: 0, Recharge: 0 });
    }

    function renderDashboard(data) {
      const totals = calculateTotals(data);
      const totalHours = Object.values(totals).reduce((a, b) => a + b, 0);

      document.getElementById('totalHours').textContent = totalHours.toFixed(1);

      renderBarChart(data);
      renderDonutChart(totals, totalHours);
      renderLegend(totals, totalHours);
      renderCategoryCards(totals, totalHours);
      
      showDashboard();
    }

    function renderBarChart(data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.day),
          datasets: [
            { label: 'MVT', data: data.map(d => d.MVT), backgroundColor: COLORS.MVT },
            { label: 'Priority', data: data.map(d => d.Priority), backgroundColor: COLORS.Priority },
            { label: 'Personal', data: data.map(d => d.Personal), backgroundColor: COLORS.Personal },
            { label: 'Recharge', data: data.map(d => d.Recharge), backgroundColor: COLORS.Recharge }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1F2937',
              titleFont: { size: 13, weight: '600' },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const total = data[idx].MVT + data[idx].Priority + data[idx].Personal + data[idx].Recharge;
                  return '\nОбщо: ' + total.toFixed(1) + 'ч';
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false },
              border: { display: false },
              ticks: { color: '#6B7280', font: { size: 12, weight: '500' } }
            },
            y: {
              stacked: true,
              grid: { color: '#F3F4F6', drawBorder: false },
              border: { display: false },
              ticks: { 
                color: '#9CA3AF', 
                font: { size: 11 },
                callback: value => value + 'ч',
                stepSize: 2
              }
            }
          },
          borderRadius: 4,
          barPercentage: 0.7,
          categoryPercentage: 0.8
        }
      });
    }

    function renderDonutChart(totals, totalHours) {
      const ctx = document.getElementById('donutChart').getContext('2d');
      if (donutChart) donutChart.destroy();

      const chartData = Object.entries(totals)
        .filter(([_, value]) => value > 0)
        .map(([category, value]) => ({ category, value, color: COLORS[category] }));

      // Handle empty state
      if (chartData.length === 0) {
        chartData.push({ category: 'Няма данни', value: 1, color: '#E5E7EB' });
      }

      donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: chartData.map(d => d.category),
          datasets: [{
            data: chartData.map(d => d.value),
            backgroundColor: chartData.map(d => d.color),
            borderWidth: 0,
            cutout: '60%',
            spacing: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1F2937',
              titleFont: { size: 13, weight: '600' },
              bodyFont: { size: 12 },
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
                  return ' ' + value.toFixed(1) + 'ч (' + pct + '%)';
                }
              }
            }
          }
        }
      });
    }

    function renderLegend(totals, totalHours) {
      const order = ['MVT', 'Priority', 'Personal', 'Recharge'];
      const legendHtml = order
        .filter(cat => totals[cat] > 0)
        .map(category => {
          const value = totals[category];
          const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
          return `
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded" style="background-color: ${COLORS[category]}"></div>
              <span class="text-sm text-gray-600">${category}</span>
              <span class="text-sm font-semibold text-gray-900">${pct}%</span>
            </div>
          `;
        }).join('');
      
      document.getElementById('legend').innerHTML = legendHtml || '<span class="text-sm text-gray-400">Няма данни</span>';
    }

    function renderCategoryCards(totals, totalHours) {
      const cardConfig = {
        MVT: { 
          bg: 'bg-red-50', border: 'border-red-100', dot: 'bg-red-500',
          label: 'text-red-700', value: 'text-red-800', desc: 'text-red-600',
          subtitle: 'Най-важните задачи'
        },
        Priority: { 
          bg: 'bg-orange-50', border: 'border-orange-100', dot: 'bg-orange-500',
          label: 'text-orange-700', value: 'text-orange-800', desc: 'text-orange-600',
          subtitle: 'Приоритетни задачи'
        },
        Personal: { 
          bg: 'bg-purple-50', border: 'border-purple-100', dot: 'bg-purple-500',
          label: 'text-purple-700', value: 'text-purple-800', desc: 'text-purple-600',
          subtitle: 'Лични ангажименти'
        },
        Recharge: { 
          bg: 'bg-green-50', border: 'border-green-100', dot: 'bg-green-500',
          label: 'text-green-700', value: 'text-green-800', desc: 'text-green-600',
          subtitle: 'Почивка & енергия'
        }
      };

      const order = ['MVT', 'Priority', 'Personal', 'Recharge'];
      const cardsHtml = order.map(category => {
        const cfg = cardConfig[category];
        const value = totals[category] || 0;
        const pct = totalHours > 0 ? ((value / totalHours) * 100).toFixed(0) : 0;
        
        return `
          <div class="${cfg.bg} rounded-xl p-4 border ${cfg.border}">
            <div class="flex items-center gap-2 mb-1">
              <div class="w-2.5 h-2.5 rounded-full ${cfg.dot}"></div>
              <span class="text-xs font-semibold ${cfg.label}">${category}</span>
            </div>
            <p class="text-2xl font-bold ${cfg.value}">${value.toFixed(1)}ч</p>
            <p class="text-xs ${cfg.desc} mt-1">${pct}% от времето</p>
            <p class="text-xs text-gray-400 mt-0.5">${cfg.subtitle}</p>
          </div>
        `;
      }).join('');
      
      document.getElementById('categoryCards').innerHTML = cardsHtml;
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      showLoading();
      
      try {
        const data = await fetchNotionData();
        renderDashboard(data);

        // Auto-refresh
        setInterval(async () => {
          try {
            const freshData = await fetchNotionData();
            renderDashboard(freshData);
          } catch (e) {
            console.error('Refresh error:', e);
          }
        }, CONFIG.refreshInterval);

      } catch (error) {
        showError(error.message || 'Неуспешно свързване с Notion');
      }
    }

    // Start
    init();
  </script>
</body>
</html>
